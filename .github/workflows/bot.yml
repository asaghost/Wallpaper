name: Daily Wallpaper Bot
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Generate and Post
        run: |
          echo "๐ค ุจุฏุก ุงููุธุงู ุงูุฐูู ูุชูููุฏ ุงูุฎูููุงุช..."
          
          # 1. ุทูุจ ุชูููุฏ ุงูุตูุฑุฉ ูุน ุฅุนุฏุงุฏุงุช ุฃูุงู ููุฎูุถุฉ ูุชุฌูุจ ุงูุญุฌุจ ุงูุชููุงุฆู
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=AIzaSyB6IW8-n9k0dxOrz9zDX59ep_SksHz5xWY" \
          -H "Content-Type: application/json" \
          -d '{
            "contents": [{"parts": [{"text": "High resolution 8k wallpaper, Galaxy and Planets, cinematic, highly detailed, mobile wallpaper style"}]}],
            "generation_config": {
              "image_config": { "aspect_ratio": "9:16" }
            },
            "safetySettings": [
              {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
            ]
          }')

          # 2. ูุญุต ุงูุฃุฎุทุงุก ูุจู ุงูุจุฏุก (ุชุญููู ุฐูู ููุฑุฏ)
          
          # ูู ููุงู ุฎุทุฃ ูู ุงูููุชุงุญ ุฃู ุงูุญุณุงุจุ
          API_ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ ! -z "$API_ERROR" ]; then
            echo "โ ุฎุทุฃ ุชููู ูู ุฌูุฌู: $API_ERROR"
            exit 1
          fi

          # ูู ุชู ุญุฌุจ ุงููุญุชูู ุจุณุจุจ ุณูุงุณุงุช ุฌูุฌูุ
          SAFETY_BLOCK=$(echo "$RESPONSE" | jq -r '.promptFeedback.blockReason // empty')
          if [ ! -z "$SAFETY_BLOCK" ]; then
            echo "โ๏ธ ุชู ุญุฌุจ ุงูุทูุจ ูู ุฌูุฌู ูุณุจุจ ูุชุนูู ุจุงูุฃูุงู: $SAFETY_BLOCK"
            echo "ูุตูุญุฉ: ุญุงูู ุชุบููุฑ 'ููุถูุน ุงูุตูุฑ' ูู ุงูุฅุนุฏุงุฏุงุช."
            exit 1
          fi

          # 3. ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ุงูุตูุฑุฉ
          IMG_DATA=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[] | select(.inlineData != null) | .inlineData.data // empty')
          
          if [ -z "$IMG_DATA" ]; then
            echo "โ ูุดู ุงุณุชุฎุฑุงุฌ ุงูุตูุฑุฉ. ุงูุฑุฏ ุงููุงุฑุฏ ูู ุฌูุฌู ูุง ูุญุชูู ุนูู ุจูุงูุงุช ุตูุฑุฉ."
            echo "ุงูุฑุฏ ุงููุงูู ูููุนุงููุฉ:"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi

          # 4. ุชุญููู ุงูุตูุฑุฉ ูุญูุธูุง
          echo "$IMG_DATA" | base64 -d > wallpaper.png
          echo "โ ุชู ุชูููุฏ ููู ุงูุตูุฑุฉ ุจูุฌุงุญ."

          # 5. ุงูุฅุฑุณุงู ูุชูุบุฑุงู ูุน ูุญุต ุงูุชููู ูุงููุนุฑู
          SEND_RES=$(curl -s -X POST "https://api.telegram.org/bot8475807409:AAHNj5nCT4BnwOrMSHoviStSUDgRwn_QO4g/sendPhoto" \
          -F "chat_id=@MobWallpaper4k" \
          -F "photo=@wallpaper.png" \
          -F "caption=๐ ุชู ุชูููุฏ ููุดุฑ ุฎูููุฉ 8K ุฌุฏูุฏุฉ!\n๐จ ุงูููุถูุน: Galaxy and Planets")

          if echo "$SEND_RES" | grep -q '"ok":true'; then
            echo "โ ุชู ุงููุดุฑ ูู ุงูููุงุฉ ุจูุฌุงุญ!"
          else
            echo "โ ูุดู ุงูุฅุฑุณุงู ูุชูุบุฑุงู. ุชุญูู ูู ุงูุชููู ุฃู ุชุฃูุฏ ุฃู ุงูุจูุช ูุณุคูู ูู ุงูููุงุฉ."
            echo "ุฑุฏ ุชูุบุฑุงู:"
            echo "$SEND_RES" | jq '.'
            exit 1
          fi
